<!-- templates/capture.html (do not change/remove this comment) -->
{% extends "base.html" %} {% block title %}Capture{% endblock %} {% block content %}
<div class="container d-flex justify-content-center align-items-center" style="height: 80vh">
	<div class="text-center">
		<h1>Webcam Feed</h1>
		<div class="embed-responsive embed-responsive-16by9 mb-3 d-flex justify-content-center align-items-center">
			<video
				id="webcam"
				autoplay
				playsinline
				style="width: 1280px; height: 720px; border: 1px solid #ccc; transform: scale(0.5); transform-origin: center center"></video>
		</div>
		<button class="btn btn-primary" id="capture-btn">Capture</button>
	</div>
</div>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		const video = document.getElementById("webcam");

		// Request access to the webcam with specific resolution
		navigator.mediaDevices
			.getUserMedia({
				video: { width: 1280, height: 720 },
			})
			.then((stream) => {
				video.srcObject = stream;
			})
			.catch((err) => {
				console.error("Error accessing webcam: ", err);
			});

		document.getElementById("capture-btn").addEventListener("click", () => {
			captureImage();
		});

		function captureImage() {
			const captureButton = document.getElementById("capture-btn");
			captureButton.disabled = true;
			captureButton.style.backgroundColor = "red";
			captureButton.textContent = "Processing...";

			const canvas = document.createElement("canvas");
			canvas.width = 1280;
			canvas.height = 720;
			const context = canvas.getContext("2d");
			context.drawImage(video, 0, 0, canvas.width, canvas.height);
			canvas.toBlob((blob) => {
				const formData = new FormData();
				formData.append("image", blob, "capture.jpg");
				fetch("/capture_image", {
					method: "POST",
					body: formData,
				})
					.then((response) => response.json())
					.then((data) => {
						if (data.success) {
							console.log("Image uploaded and processed:", data.filepath);
							// Redirect to results page or handle success
							window.location.href = "/results";
						} else {
							console.error("Error uploading image:", data.error);
							captureButton.disabled = false;
							captureButton.style.backgroundColor = "";
							captureButton.textContent = "Capture";
						}
					})
					.catch((error) => {
						console.error("Error:", error);
						captureButton.disabled = false;
						captureButton.style.backgroundColor = "";
						captureButton.textContent = "Capture";
					});
			}, "image/jpeg");
		}
	});
</script>
{% endblock %}
